# æ–‡ä»¶æ‰«ææœåŠ¡ä½¿ç”¨æŒ‡å—

## ğŸ“š æ¦‚è¿°

Voice Book çš„æ–‡ä»¶æ‰«ææœåŠ¡æä¾›äº†å®Œæ•´çš„éŸ³é¢‘æ–‡ä»¶ç®¡ç†åŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š
- æƒé™ç®¡ç†ï¼ˆPermissionServiceï¼‰
- æ–‡ä»¶æ‰«æï¼ˆFileScannerServiceï¼‰

## ğŸ”§ æœåŠ¡è¯´æ˜

### 1. PermissionService - æƒé™ç®¡ç†æœåŠ¡

è´Ÿè´£å¤„ç†åº”ç”¨æ‰€éœ€çš„å„ç§æƒé™ï¼ŒåŒ…æ‹¬å­˜å‚¨æƒé™å’Œé€šçŸ¥æƒé™ã€‚

**ä½ç½®**: `lib/services/permission_service.dart`

**ä¸»è¦åŠŸèƒ½**:
- âœ… è¯·æ±‚å­˜å‚¨æƒé™ï¼ˆæ”¯æŒ Android 13+ çš„æ–°æƒé™æ¨¡å‹ï¼‰
- âœ… æ£€æŸ¥æƒé™çŠ¶æ€
- âœ… è¯·æ±‚é€šçŸ¥æƒé™
- âœ… æ‰“å¼€åº”ç”¨è®¾ç½®é¡µé¢

**ä½¿ç”¨ç¤ºä¾‹**:

```dart
import 'package:voice_book/services/permission_service.dart';

// è·å–æœåŠ¡å®ä¾‹
final permissionService = PermissionService();

// è¯·æ±‚å­˜å‚¨æƒé™
final granted = await permissionService.requestStoragePermission();
if (granted) {
  print('å­˜å‚¨æƒé™å·²æˆäºˆ');
} else {
  print('å­˜å‚¨æƒé™è¢«æ‹’ç»');
}

// æ£€æŸ¥æƒé™çŠ¶æ€
final hasPermission = await permissionService.checkStoragePermission();

// è¯·æ±‚æ‰€æœ‰å¿…éœ€çš„æƒé™
final permissions = await permissionService.requestAllPermissions();
print('å­˜å‚¨æƒé™: ${permissions['storage']}');
print('é€šçŸ¥æƒé™: ${permissions['notification']}');

// æ‰“å¼€åº”ç”¨è®¾ç½®é¡µé¢ï¼ˆå½“æƒé™è¢«æ°¸ä¹…æ‹’ç»æ—¶ï¼‰
await permissionService.openSettings();
```

---

### 2. FileScannerService - æ–‡ä»¶æ‰«ææœåŠ¡

è´Ÿè´£æ‰«ææœ¬åœ°å­˜å‚¨ä¸­çš„éŸ³é¢‘æ–‡ä»¶ï¼Œè¯»å–å…ƒæ•°æ®ï¼Œå¹¶æä¾›æ–‡ä»¶ç®¡ç†åŠŸèƒ½ã€‚

**ä½ç½®**: `lib/services/file_scanner_service.dart`

**æ”¯æŒçš„éŸ³é¢‘æ ¼å¼**:
- MP3 (.mp3)
- M4A/M4B (.m4a, .m4b)
- WAV (.wav)
- FLAC (.flac)
- AAC (.aac)
- OGG (.ogg)
- OPUS (.opus)
- WMA (.wma)

**ä¸»è¦åŠŸèƒ½**:
- âœ… æ‰«ææŒ‡å®šç›®å½•ä¸‹çš„éŸ³é¢‘æ–‡ä»¶
- âœ… é€’å½’æ‰«æå­ç›®å½•
- âœ… è¯»å–éŸ³é¢‘æ–‡ä»¶å…ƒæ•°æ®ï¼ˆæ ‡é¢˜ã€ä½œè€…ã€ä¸“è¾‘ã€æ—¶é•¿ç­‰ï¼‰
- âœ… æ‰¹é‡å¤„ç†éŸ³é¢‘æ–‡ä»¶
- âœ… æŒ‰ç›®å½•åˆ†ç»„
- âœ… æ–‡ä»¶æ’åºï¼ˆæŒ‰åç§°ã€å¤§å°ï¼‰
- âœ… è·å–å¸¸ç”¨éŸ³é¢‘ç›®å½•

**ä½¿ç”¨ç¤ºä¾‹**:

#### åŸºæœ¬æ‰«æ

```dart
import 'package:voice_book/services/file_scanner_service.dart';

// è·å–æœåŠ¡å®ä¾‹
final scanner = FileScannerService();

// æ‰«ææŒ‡å®šç›®å½•
final files = await scanner.scanDirectory(
  '/storage/emulated/0/Music',
  recursive: true, // é€’å½’æ‰«æå­ç›®å½•
  onProgress: (count) {
    print('å·²æ‰«æ $count ä¸ªæ–‡ä»¶');
  },
);

print('æ‰¾åˆ° ${files.length} ä¸ªéŸ³é¢‘æ–‡ä»¶');
```

#### æ‰«æå¤šä¸ªç›®å½•

```dart
// æ‰«æå¤šä¸ªç›®å½•
final directories = [
  '/storage/emulated/0/Music',
  '/storage/emulated/0/Download',
  '/storage/emulated/0/Audiobooks',
];

final files = await scanner.scanMultipleDirectories(
  directories,
  recursive: true,
  onProgress: (count) {
    print('å·²æ‰«æ $count ä¸ªæ–‡ä»¶');
  },
);
```

#### è·å–å¸¸ç”¨ç›®å½•

```dart
// è·å–ç³»ç»Ÿä¸­å¸¸ç”¨çš„éŸ³é¢‘æ–‡ä»¶å­˜å‚¨ä½ç½®
final commonDirs = await scanner.getCommonAudioDirectories();
print('å¸¸ç”¨ç›®å½•: $commonDirs');
```

#### è¯»å–å…ƒæ•°æ®

```dart
// è¯»å–å•ä¸ªæ–‡ä»¶çš„å…ƒæ•°æ®
final metadata = await scanner.readMetadata(files[0]);
print('æ ‡é¢˜: ${metadata['title']}');
print('ä½œè€…: ${metadata['artist']}');
print('ä¸“è¾‘: ${metadata['album']}');
print('æ—¶é•¿: ${metadata['duration']} æ¯«ç§’');
print('æ–‡ä»¶å¤§å°: ${metadata['fileSize']} å­—èŠ‚');

// æ‰¹é‡è¯»å–å…ƒæ•°æ®
final metadataList = await scanner.readMultipleMetadata(
  files,
  onProgress: (current, total) {
    print('æ­£åœ¨å¤„ç† $current/$total');
  },
);
```

#### æ–‡ä»¶åˆ†ç»„å’Œæ’åº

```dart
// æŒ‰ç›®å½•åˆ†ç»„
final groupedFiles = scanner.groupFilesByDirectory(files);
groupedFiles.forEach((directory, fileList) {
  print('ç›®å½•: $directory, æ–‡ä»¶æ•°: ${fileList.length}');
});

// æŒ‰æ–‡ä»¶åæ’åº
final sortedByName = scanner.sortFilesByName(files, ascending: true);

// æŒ‰æ–‡ä»¶å¤§å°æ’åº
final sortedBySize = await scanner.sortFilesBySize(files, ascending: false);
```

#### å·¥å…·æ–¹æ³•

```dart
// æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
final sizeStr = scanner.formatFileSize(1024 * 1024 * 5); // "5.0 MB"

// è·å–éŸ³é¢‘æ–‡ä»¶æ€»æ—¶é•¿
final totalDuration = await scanner.getTotalDuration(files);
print('æ€»æ—¶é•¿: ${totalDuration / 1000 / 60} åˆ†é’Ÿ');
```

---

## ğŸ¯ å®Œæ•´ä½¿ç”¨æµç¨‹

### åœºæ™¯ï¼šç”¨æˆ·å¯¼å…¥éŸ³é¢‘æ–‡ä»¶

```dart
import 'package:voice_book/services/permission_service.dart';
import 'package:voice_book/services/file_scanner_service.dart';
import 'package:voice_book/providers/book_provider.dart';

Future<void> importAudioFiles(BuildContext context) async {
  // 1. è¯·æ±‚æƒé™
  final permissionService = PermissionService();
  final hasPermission = await permissionService.requestStoragePermission();

  if (!hasPermission) {
    // æ˜¾ç¤ºæƒé™è¢«æ‹’ç»çš„æç¤º
    ScaffoldMessenger.of(context).showSnackBar(
      const SnackBar(content: Text('éœ€è¦å­˜å‚¨æƒé™æ‰èƒ½å¯¼å…¥éŸ³é¢‘æ–‡ä»¶')),
    );
    return;
  }

  // 2. æ‰«æéŸ³é¢‘æ–‡ä»¶
  final scanner = FileScannerService();
  final directories = await scanner.getCommonAudioDirectories();

  // æ˜¾ç¤ºåŠ è½½æç¤º
  showDialog(
    context: context,
    barrierDismissible: false,
    builder: (context) => const Center(child: CircularProgressIndicator()),
  );

  final files = await scanner.scanMultipleDirectories(
    directories,
    recursive: true,
    onProgress: (count) {
      print('å·²æ‰«æ $count ä¸ªæ–‡ä»¶');
    },
  );

  // 3. è¯»å–å…ƒæ•°æ®
  final metadataList = await scanner.readMultipleMetadata(
    files,
    onProgress: (current, total) {
      print('æ­£åœ¨å¤„ç† $current/$total');
    },
  );

  // 4. ä¿å­˜åˆ°æ•°æ®åº“
  final bookProvider = context.read<BookProvider>();

  for (final metadata in metadataList) {
    // åˆ›å»ºæˆ–è·å–ä¹¦ç±
    final book = await bookProvider.addBook(
      title: metadata['album'] ?? 'æœªçŸ¥ä¸“è¾‘',
      author: metadata['artist'] ?? 'æœªçŸ¥ä½œè€…',
    );

    // æ·»åŠ éŸ³é¢‘æ–‡ä»¶
    await bookProvider.addAudioFile(
      bookId: book.id!,
      filePath: metadata['filePath'],
      title: metadata['title'],
      duration: metadata['duration'],
      fileSize: metadata['fileSize'],
      trackNumber: metadata['trackNumber'],
    );
  }

  // å…³é—­åŠ è½½æç¤º
  Navigator.of(context).pop();

  // æ˜¾ç¤ºæˆåŠŸæç¤º
  ScaffoldMessenger.of(context).showSnackBar(
    SnackBar(content: Text('æˆåŠŸå¯¼å…¥ ${files.length} ä¸ªéŸ³é¢‘æ–‡ä»¶')),
  );
}
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æƒé™é…ç½®

éœ€è¦åœ¨ `android/app/src/main/AndroidManifest.xml` ä¸­æ·»åŠ æƒé™å£°æ˜ï¼š

```xml
<manifest xmlns:android="http://schemas.android.com/apk/res/android">
    <!-- å­˜å‚¨æƒé™ -->
    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />
    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />

    <!-- Android 13+ éŸ³é¢‘æƒé™ -->
    <uses-permission android:name="android.permission.READ_MEDIA_AUDIO" />

    <!-- é€šçŸ¥æƒé™ -->
    <uses-permission android:name="android.permission.POST_NOTIFICATIONS" />

    <!-- ç®¡ç†å¤–éƒ¨å­˜å‚¨æƒé™ï¼ˆå¯é€‰ï¼‰ -->
    <uses-permission android:name="android.permission.MANAGE_EXTERNAL_STORAGE" />

    <application>
        ...
    </application>
</manifest>
```

### 2. æ€§èƒ½ä¼˜åŒ–

- å¤§ç›®å½•æ‰«æå¯èƒ½è€—æ—¶è¾ƒé•¿ï¼Œå»ºè®®æ˜¾ç¤ºè¿›åº¦æç¤º
- ä½¿ç”¨ `onProgress` å›è°ƒæ›´æ–° UI
- è€ƒè™‘ä½¿ç”¨ `Isolate` è¿›è¡Œåå°æ‰«æï¼ˆé¿å…é˜»å¡ UI çº¿ç¨‹ï¼‰

### 3. é”™è¯¯å¤„ç†

- å¤„ç†æƒé™è¢«æ‹’ç»çš„æƒ…å†µ
- å¤„ç†ç›®å½•ä¸å­˜åœ¨çš„æƒ…å†µ
- å¤„ç†å…ƒæ•°æ®è¯»å–å¤±è´¥çš„æƒ…å†µï¼ˆä½¿ç”¨é»˜è®¤å€¼ï¼‰

### 4. ä¾èµ–åŒ…

ç¡®ä¿åœ¨ `pubspec.yaml` ä¸­æ·»åŠ äº†ä»¥ä¸‹ä¾èµ–ï¼š

```yaml
dependencies:
  permission_handler: ^11.0.1
  flutter_media_metadata: ^1.0.0
  file_picker: ^6.1.1
  path: ^1.8.3
  path_provider: ^2.1.2
```

è¿è¡Œ `flutter pub get` å®‰è£…ä¾èµ–ã€‚

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [éœ€æ±‚æ–‡æ¡£](./éœ€æ±‚æ–‡æ¡£.md)
- [é¡¹ç›®çŠ¶æ€](./é¡¹ç›®çŠ¶æ€.md)
- [CLAUDE.md](../CLAUDE.md)

---

## ğŸ“ æ›´æ–°æ—¥å¿—

### 2025-11-29
- âœ… åˆ›å»º PermissionServiceï¼ˆæƒé™ç®¡ç†æœåŠ¡ï¼‰
- âœ… åˆ›å»º FileScannerServiceï¼ˆæ–‡ä»¶æ‰«ææœåŠ¡ï¼‰
- âœ… æ·»åŠ éŸ³é¢‘å…ƒæ•°æ®è¯»å–åŠŸèƒ½
- âœ… æ”¯æŒ 9 ç§éŸ³é¢‘æ ¼å¼
- âœ… å®Œæ•´çš„ä¸­æ–‡æ³¨é‡Šå’Œæ–‡æ¡£
