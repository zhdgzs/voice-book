# Voice Book 测试指南

## 📋 测试准备

### 1. 安装依赖

在项目根目录运行：

```bash
flutter pub get
```

这将安装以下新增的依赖包：
- `flutter_media_metadata: ^1.0.0` - 音频元数据读取
- `file_picker: ^6.1.1` - 文件选择器

### 2. 配置 Android 权限

#### 方法一：手动配置（推荐）

编辑 `android/app/src/main/AndroidManifest.xml`，在 `<manifest>` 标签内添加：

```xml
<!-- 存储权限（Android 12 及以下） -->
<uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"
                 android:maxSdkVersion="32" />
<uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"
                 android:maxSdkVersion="32" />

<!-- Android 13+ 音频权限 -->
<uses-permission android:name="android.permission.READ_MEDIA_AUDIO" />

<!-- 通知权限（Android 13+） -->
<uses-permission android:name="android.permission.POST_NOTIFICATIONS" />
```

#### 方法二：使用完整配置

参考 `docs/Android权限配置.md` 中的完整配置示例。

### 3. 准备测试数据

在您的 Android 设备上准备一些音频文件：
- 将音频文件放在 `/storage/emulated/0/Music/` 目录
- 或者放在 `/storage/emulated/0/Download/` 目录
- 支持的格式：MP3, M4A, WAV, FLAC, AAC, OGG, OPUS, WMA

---

## 🚀 运行测试

### 1. 连接设备

确保您的 Android 设备已连接并启用 USB 调试：

```bash
# 检查设备连接
flutter devices

# 应该看到类似输出：
# Android SDK built for x86 (mobile) • emulator-5554 • android-x86 • Android 11 (API 30)
```

### 2. 运行应用

```bash
# 运行应用
flutter run

# 或者指定设备
flutter run -d <device-id>
```

### 3. 测试流程

应用启动后，您将看到首页：

#### 步骤 1：进入测试页面
1. 点击首页的 **"测试文件扫描功能"** 按钮
2. 进入文件扫描测试页面

#### 步骤 2：请求权限
1. 如果显示 **"需要请求存储权限"**，点击 **"请求权限"** 按钮
2. 在弹出的权限对话框中，选择 **"允许"**
3. 如果权限被拒绝，会显示提示，可以点击 **"打开设置"** 手动授予

#### 步骤 3：扫描音频文件
1. 权限授予后，点击 **"扫描音频文件"** 按钮
2. 应用会自动扫描常用目录（Music、Download、Audiobooks 等）
3. 扫描过程中会显示进度：**"已扫描 X 个音频文件..."**
4. 扫描完成后会显示：**"扫描完成！找到 X 个音频文件"**

#### 步骤 4：读取元数据
1. 扫描完成后，点击 **"读取元数据"** 按钮
2. 应用会读取前 10 个文件的元数据（避免耗时过长）
3. 读取过程中会显示进度：**"正在读取元数据 X/Y..."**
4. 读取完成后，会在列表中显示音频文件信息

#### 步骤 5：查看详情
1. 点击列表中任意文件右侧的 **"ℹ️"** 图标
2. 查看文件的详细信息：
   - 标题、作者、专辑
   - 时长、文件大小
   - 曲目编号、年份、流派
   - 文件路径

---

## ✅ 测试检查清单

### 权限测试
- [ ] 首次启动时，权限状态显示为 **"需要请求存储权限"**
- [ ] 点击 **"请求权限"** 后，弹出系统权限对话框
- [ ] 授予权限后，状态变为 **"已有存储权限"**
- [ ] 拒绝权限后，显示提示信息和 **"打开设置"** 选项

### 文件扫描测试
- [ ] 点击 **"扫描音频文件"** 后，显示扫描进度
- [ ] 扫描过程中，进度数字实时更新
- [ ] 扫描完成后，显示找到的文件数量
- [ ] 扫描结果准确（与实际文件数量一致）

### 元数据读取测试
- [ ] 点击 **"读取元数据"** 后，显示读取进度
- [ ] 读取完成后，列表显示文件信息
- [ ] 文件信息准确（标题、作者、专辑等）
- [ ] 时长和文件大小显示正确
- [ ] 点击详情按钮，弹出详细信息对话框

### UI 测试
- [ ] 界面布局正常，无错位
- [ ] 按钮可点击，响应正常
- [ ] 进度条显示正常
- [ ] 列表滚动流畅
- [ ] 主题切换正常（浅色/深色）

---

## 🐛 常见问题

### 1. 权限请求失败

**问题**: 点击 "请求权限" 后，没有弹出权限对话框

**解决方案**:
- 检查 `AndroidManifest.xml` 是否正确配置权限
- 卸载应用后重新安装
- 在设备设置中手动授予权限

### 2. 扫描不到文件

**问题**: 扫描完成后显示 "找到 0 个音频文件"

**解决方案**:
- 确认设备上确实有音频文件
- 检查文件格式是否支持（MP3, M4A, WAV 等）
- 检查文件是否在常用目录（Music、Download 等）
- 尝试手动指定目录扫描

### 3. 元数据读取失败

**问题**: 读取元数据时显示 "未知标题"、"未知作者"

**解决方案**:
- 这是正常现象，某些音频文件可能没有元数据
- 应用会使用文件名作为默认标题
- 可以尝试使用其他音频文件测试

### 4. 应用崩溃

**问题**: 扫描或读取元数据时应用崩溃

**解决方案**:
- 查看控制台日志，找到错误信息
- 检查是否是某个特定文件导致的崩溃
- 尝试减少扫描的文件数量
- 提交 Issue 并附上错误日志

### 5. 依赖安装失败

**问题**: `flutter pub get` 失败

**解决方案**:
```bash
# 清理缓存
flutter clean

# 重新获取依赖
flutter pub get

# 如果还是失败，尝试升级 Flutter
flutter upgrade
```

---

## 📊 性能测试

### 扫描性能
- 扫描 100 个文件：预计 1-2 秒
- 扫描 1000 个文件：预计 5-10 秒
- 扫描 10000 个文件：预计 30-60 秒

### 元数据读取性能
- 读取 10 个文件：预计 2-5 秒
- 读取 100 个文件：预计 20-50 秒

**注意**: 实际性能取决于设备性能和文件大小

---

## 🔍 调试技巧

### 查看日志

```bash
# 实时查看日志
flutter logs

# 过滤特定标签
flutter logs | grep "FileScannerService"
```

### 常用日志输出

在代码中添加了以下日志输出：
- `扫描目录失败: <path>, 错误: <error>`
- `读取元数据失败: <path>, 错误: <error>`
- `已扫描 X 个文件`
- `正在读取元数据 X/Y`

---

## 📝 测试报告模板

测试完成后，请填写以下信息：

```
## 测试环境
- 设备型号: [例如: Pixel 6]
- Android 版本: [例如: Android 13]
- Flutter 版本: [运行 flutter --version 查看]

## 测试结果
- [ ] 权限请求正常
- [ ] 文件扫描正常
- [ ] 元数据读取正常
- [ ] UI 显示正常

## 测试数据
- 扫描文件数量: [例如: 150 个]
- 扫描耗时: [例如: 3 秒]
- 元数据读取数量: [例如: 10 个]
- 元数据读取耗时: [例如: 5 秒]

## 发现的问题
[描述遇到的问题]

## 建议
[提出改进建议]
```

---

## 🎯 下一步

测试通过后，可以继续开发：
1. 创建文件导入页面
2. 创建书架页面
3. 创建书籍详情页面
4. 实现音频播放功能

---

## 🔗 相关文档

- [文件扫描服务使用指南](./文件扫描服务使用指南.md)
- [Android 权限配置](./Android权限配置.md)
- [项目状态](./项目状态.md)

---

**祝测试顺利！** 🎉
